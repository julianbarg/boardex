---
jupyter:
  jupytext:
    formats: ipynb,Rmd
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.2.1
  kernelspec:
    display_name: R 3.6.1
    language: R
    name: ir361
---

<!-- #region {"slideshow": {"slide_type": "slide"}} -->
# Data validation
<!-- #endregion -->

<!-- #region {"slideshow": {"slide_type": "subslide"}} -->
## Setup
<!-- #endregion -->

```{r}
library(tidyverse)
```

```{r slideshow={'slide_type': 'subslide'}}
na_summary <- arrow::read_feather("data/na_summary_preprocessed.feather")

head(na_summary)
```

<!-- #region {"slideshow": {"slide_type": "slide"}} -->
## Check for duplicates
<!-- #endregion -->

<!-- #region {"slideshow": {"slide_type": "subslide"}} -->
### Annual report inconsistencies
<!-- #endregion -->

```{r slideshow={'slide_type': 'subslide'}}
na_summary %>%
    select(isin, annualreportdate, companyid) %>%
    group_by(isin, annualreportdate) %>%
    summarize(n = n_distinct(companyid)) %>%
    filter(n > 1)
```

```{r slideshow={'slide_type': 'subslide'}}
na_summary %>%
    filter(isin == "US30224P2002" & annualreportdate == "2013-12-01") %>%
    select(isin, annualreportdate, companyid, everything()) %>%
    head()
```

Looks like there is something funky going on with this one observation. Let's drop it.

<!-- #region {"slideshow": {"slide_type": "subslide"}} -->
### Drop offending observation
<!-- #endregion -->

```{r}
na_summary <- filter(na_summary,isin != "US30224P2002")
```

### Check other variables

```{r}
na_summary %>%
    select(isin, annualreportdate) %>%
    n_distinct()

na_summary %>%
    select(isin, annualreportdate, companyid, numberdirectors, nationalitymix, genderratio) %>%
    group_by(isin, annualreportdate) %>%
    n_distinct()
```

Looks good

<!-- #region {"slideshow": {"slide_type": "subslide"}} -->
### Multiple annual reports in a year
<!-- #endregion -->

If there are multple annual reports in any year, the number of entries should be reduced when we extract only the year from the annual report date column.

```{r}
na_summary %>%
    select(companyid, annualreportdate) %>%
    n_distinct()
```

```{r}
na_summary %>%
    mutate(year = lubridate::year(annualreportdate)) %>%
    select(companyid, year) %>%
    n_distinct()
```

<!-- #region {"slideshow": {"slide_type": "subslide"}} -->
Let's drop these, too.
<!-- #endregion -->

```{r}
na_summary %>%
    mutate(year = lubridate::year(annualreportdate)) %>%
    group_by(companyid, year) %>%
    mutate(n = n_distinct(annualreportdate)) %>%
    filter(n == 1) %>%
    ungroup() %>%
    select(companyid, annualreportdate) %>%
    n_distinct()
```

```{r}
na_summary %>%
    mutate(year = lubridate::year(annualreportdate)) %>%
    group_by(companyid, year) %>%
    summarize(n = n_distinct(annualreportdate)) %>%
    filter(n > 1)
```

```{r}

```
